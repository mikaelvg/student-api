  KeyPair, !Ref KeyName, !Ref "AWS::NoValue" ]
  Monitoring:
    Enabled: true
  SecurityGroups:
    - GroupId: !If [ CreateNewSecurityGroup, !Ref EcsSecurityGroup, !Ref SecurityGroupId ]
  SubnetId: !If
    - CreateSubnet1
    - !If
      - CreateSubnet2
      - !If
        - CreateSubnet3
        - !Join [ "," , [ !Ref PubSubnetAz1, !Ref PubSubnetAz2, !Ref PubSubnetAz3 ] ]
        - !Join [ "," , [ !Ref PubSubnetAz1, !Ref PubSubnetAz2 ] ]
      - !Ref PubSubnetAz1
    - !Join [ "," , !Ref SubnetIds ]
  BlockDeviceMappings:
    - DeviceName: !Ref DeviceName
      Ebs:
        VolumeSize: !Ref EbsVolumeSize
        VolumeType: !Ref EbsVolumeType
  UserData:
    Fn::Base64: !Ref UserData
  Outputs:
    EcsInstanceAsgName:
      Condition: CreateWithASG
      Description: Auto Scaling Group Name for ECS Instances
      Value: !Ref EcsInstanceAsg
    EcsSpotFleetRequestId:
      Condition: CreateWithSpot
      Description: Spot Fleet Request for ECS Instances
      Value: !Ref EcsSpotFleet
    UsedByECSCreateCluster:
      Description: Flag used by ECS Create Cluster Wizard
      Value: 'true'
    TemplateVersion:
      Description: The version of the template used by Create Cluster Wizard
      Value: '2.0.0'